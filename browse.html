<html>
 <head>
  <meta http-equiv=" Content-Type" content="text/html;charset=UTF-8">
  <link type="text/css" rel="stylesheet" href="css/basic.css" />
  <link rel="stylesheet" type="text/css" href="css/overlay-basic.css"/>
  <script type="text/javascript" src='lib/jquery.js'></script>
  <script src="lib/jquery.tools.min.js"></script>
  <script src="lib/jquery.ba-hashchange.js"></script>


<!--<meta name="viewport" content="width=1000" />-->

  <title>Browse Video Archives</title>

 </head>


<body onload="insert()">
<script type="text/javascript">

//variables after #
var url_crid=null;
var q=null;
var term=null;
var pr = window.location.hash;
//alert(pr);
if(pr){   
  if(pr.match("crid://")){
    url_crid=pr.substring(1);
  }
  if(pr.match("q=")){
    q=pr.substring(3);
  }
  if(pr.match("term=")){
    term=pr.substring(6);
  }
}

//hashchange stuff

$(function(){
  // Bind the event.
  $(window).hashchange( function(){
    // Alerts every time the hash changes!
   var pr = location.hash;
   if(pr){   
     if(pr.match("crid://")){
       url_crid=pr.substring(1);
       if(url_crid){
//alert(url_crid);
        refresh_suggestions(url_crid);
       }
     }
     if(pr.match("q=")){
       q=pr.substring(3);
       if(q){
         do_search(q);
       }
     }
     if(pr.match("term=")){
       term=pr.substring(6);
       if(term){
         do_cat_search(term);
       }
     }

   }

  });
 
  // Trigger the event (useful on page load).
  $(window).hashchange();
});

var playlist_changed=false;
var search_url = "http://dev.notu.be/2011/01/api/search"
var suggest_url = "http://dev.notu.be/2011/01/api/suggest";
var start_url="http://dev.notu.be/2011/01/api/random?fmt=json";

var checked = false;
var user_id="unknown";

function insert2(script) {
   var headID = document.getElementsByTagName("head")[0];
   var newScript = document.createElement('script');
   newScript.type = 'text/javascript';
   newScript.src = script;
   headID.appendChild(newScript);
}


function do_search(txt){
//alert(search_url+"?q="+txt+"&fmt=json ....");
   window.location.hash="#q="+txt;
   insert2(search_url+"?q="+txt+"&fmt=json&user_id="+user_id);
}


function do_cat_search(txt){
///alert(search_url+"?cat="+txt+"&fmt=json ,,,,");
   window.location.hash="#term="+txt;
   insert2(search_url+"?cat="+txt+"&fmt=json&user_id="+user_id);
}



function search_results(ob){
//alert(ob.length)

  var html = "<h3>Programmes about ";
  if(ob.length==1){
    var t = ob[0]["term"];
    var tn = ob[0]["term_name"];
    html=tn+"</h3>\n<ul><li>Sorry, nothing found</li>\n";
    suggest1(html)//fix!
    r.innerHTML=html;
  }else{
     var t = ob[0]["term"];
     var tn = ob[0]["term_name"];
     html=html+""+tn+"</h3>\n<ul>\n";
     for (var i=1; i<ob.length; i++){
        var cct = ob[i]["core_title"];
        var sst = ob[i]["series_title"];

        if(sst){
          sst = capitalise(sst);
        }                  

        if(cct){
          cct = capitalise(cct);
        }

        var fulltitle ="";
        if(cct && cct!="" && cct!=" "){
           if(sst && sst!=""){
             fulltitle = sst +": "+cct;           
           }else{
             fulltitle = cct;           
           }
        }else{
           if(sst && sst!=""){
             fulltitle = sst;           
           }
        }

        html = html+"<li><b><a href=\"#"+ob[i]["crid"]+"\" onclick=\"javascript:refresh_suggestions('"+ob[i]["crid"]+"')\">"+fulltitle+"</a></b><p>"+ob[i]["text_date"]+" on "+ob[i]["channel"]+"</p></li>\n"

     }
     html = html+"</ul>";
//   suggest1(html);
     document.getElementById("cat_search");
     cat_search.innerHTML=html;
     show_cat_search();
  }
}


function capitalise(txt){

var arr = txt.split(/[.|,| |\(|\)|\[|\]]/);
var arr2 = [];
//split
  for(x in arr){
    var str = arr[x];
    var letter = str.substr(0,1);
    arr2.push(letter.toUpperCase() + str.substr(1).toLowerCase());
  }

 return arr2.join(" ");
}

//process the script results
function recommendations(result){

          var pn = result["programme_number"];
          var ct = result["core_title"];
          var st = result["series_title"];
          var img = result["image"];
          var suggestions = result["suggestions"];
          var crid = result["crid"];
          var pid = result["pid"];
          var ddtt = result["date_time"];
          var text_date = result["text_date"];
          var channel = result["channel"];
          var description = result["description"];
          var catz = result["categories"];
        

          if(catz){
             var cats ="<span class='cat'><b>More programmes about:</b> ";
             for(var i in catz){
                   var tn = catz[i]["term_name"];
                   tn = tn.toLowerCase();
                   var tnum = catz[i]["term"];
                   cats = cats+"<a href=\"#term="+tnum+"\" onclick=\"javascript:do_cat_search('"+tnum+"');return false;\">"+tn+"</a> ";
             }
             cats = cats+"</span>";
             print_cats(cats);
          }

          if(pid){
            if(description){
               telly("<p>"+description+"</p>");
            }

            if(img){
               image("<img src=\""+img+"\" width=\"512\"/>")
            }
          }else{
///            image("<img src=\"images/bbc_logo.jpg\" width=\"512\"/>");

            if(!pn){
            }else{

              if(description){
                telly("<p>"+description+"</p>");
              }else{
                telly("<p>No description found</p>");
              }
            }
          }



          var ti = "";
          if(st){
            st = capitalise(st);
          }                  

          if(ct){
            ct = capitalise(ct);
          }
          if(st && st!=" " && st!=""){
             ti = st;
             if(ct && ct!=" " && ct!=""){
               ti = st+" : "+ct;
             }else{
               ti = st;
             }
          }else{
             if(ct && ct!=" " && ct!=""){
               ti = ct;
             }
          }

          var playlist = " <big><a href=\"#\" title=\"Add to playlist\" onclick=\"javascript:playlist_add('"+crid+"');return false;\">[+]</a></big> ";
          if(crid){
            ti = ti+""+playlist;
          }

          var s="";
          var term_term="Related by";
          if(ct || st){
            title(ti);
            s = "<h3 style='padding-left:8px'>Related Programmes</h3>";
          }else{
            s = "<h3 style='padding-left:8px'>Random Selection</h3>";
            term_term="More programmes about";

          }
          var s1 ="";
          var s2 ="";

          if (suggestions.length>0){

            var count = 0;
            var num = suggestions.length/2;
            for (r in suggestions){
                count = count + 1;
                var categories = suggestions[r]["categories"];
                var cats = "";
                var cc = 0;
                for (r2 in categories){
                   var tn = categories[r2]["term_name"];
                   var wd = categories[r2]["word"];
                   var tnum = categories[r2]["term"];
                   var freq = categories[r2]["term_frequency"];
                   tn = tn.toLowerCase();
                   cats = cats+"<a href=\"#term="+tnum+"\" onclick=\"javascript:do_cat_search('"+tnum+"');return false;\">"+tn+"</a>";
                   cc = cc+1;

                   if (cc<categories.length){
                       cats = cats+", ";
                   }
                }
                var st1 = suggestions[r]["series_title"];
                var ct1 = suggestions[r]["core_title"];
                var crid1 = suggestions[r]["crid"];
                var desc = suggestions[r]["description"];
                var ppid = suggestions[r]["pid"];
                var img = suggestions[r]["image"];
                var pn1 = suggestions[r]["programme_number"];
                var ddtt = suggestions[r]["date_time"];
                var text_date = suggestions[r]["text_date"];
                var pid = suggestions[r]["pid"];


                if(st1){
                  st1 = capitalise(st1);
                }
                if(ct1){
                  ct1 = capitalise(ct1);
                }


                if(img){

                   s = s+ "<div class=\"rec\"><a href=\"#"+crid1+"\" onclick=\"javascript:refresh_suggestions('"+crid1+"')\"><img src='"+img+"' width='150' border='0'/></a></div>";
                }


                if (st1 && st1!="" && st1!=" "){
                  s = s+"<div class=\"rectext\"> <b><a href=\"#"+crid1+"\" onclick=\"javascript:refresh_suggestions('"+crid1+"')\">"+st1+": "+ct1+"</a></b>"
                }else{
                  s = s+"<div class=\"rectext\"> <b><a href=\"#"+crid1+"\" onclick=\"javascript:refresh_suggestions('"+crid1+"')\">"+ct1+"</a></b>"
                }

                var playlist = " <big><a href=\"#\" title=\"Add to playlist\" onclick=\"javascript:playlist_add('"+crid1+"');return false;\">[+]</a></big> ";
                if(crid1){
                  s = s+""+playlist;
                }

                if(text_date){
                   s = s+"<br /><small>"+text_date+"</small><br />";
                }
                if(desc){
                   s = s+""+desc;
                }
                if(cats && cats!=""){
                  s = s+ "<br /><span class=\"cat\">"+term_term+": "+cats+"</span>\n";
                }
                s = s+ "</div><div style=\"clear:both;\"></div>\n";
            }
          
            s = s + "</div>";
            suggest1(s);
          }
}

function programme(thing){
 var desc = thing["programme"]["medium_synopsis"];
 telly("<p>"+desc+"</p>");

}

var script = start_url;

function do_random(){
    var headID = document.getElementsByTagName("head")[0];
    var newScript = document.createElement('script');
    newScript.type = 'text/javascript';
    newScript.src = script;
    headID.appendChild(newScript); 
}


function showPlaylistButton(user_id){
//<button type='button' onclick='javascript:show_playlist();return false;'>Show Playlist</button></span>
  var d = document.getElementById("playlistButton");
  d.innerHTML="<small><a href=\"#\" onclick=\"javascript:show_playlist('"+user_id+"');return false;\">Show Playlist</a></small>";
  var dx = document.getElementById("playlistButtonXML");
  dx.innerHTML="<small><a href=\"http://dev.notu.be/2011/01/api/playlist?action=get&user_id="+user_id+"&fmt=xml\" target=\"_blank\">XML</a></small>";

}

//inject start script

function insert() {
   checkCookies();
   if(!checked){
      popup_starter();
   }else{
//     alert("ok! "+user_id);
   }
   

   getPlaylist(user_id);
   //show_playlist();
   
   if(url_crid){
    refresh_suggestions(url_crid);
   }else if(q){
    do_search(q);
   }else if(term){
    do_cat_search(term);
   }else{
    var headID = document.getElementsByTagName("head")[0];
    var newScript = document.createElement('script');
    newScript.type = 'text/javascript';
    newScript.src = script;
    headID.appendChild(newScript);
   }
}


//ok: need to load playlist before we start and keep it loaded
// at any time we need to show it
// or to filter using it
function getPlaylist(user_id){
    var u ="http://dev.notu.be/2011/01/api/playlist?action=get&user_id="+user_id+"&fmt=json";
//alert(u);
    var headID = document.getElementsByTagName("head")[0];
    var newScript = document.createElement('script');
    newScript.type = 'text/javascript';
    newScript.src = u;
    headID.appendChild(newScript); 
    playlist_changed=false;
}

function playlist_get_process(result){

          var suggestions = result["suggestions"];
          var s = "";
          if (suggestions.length>0){
          
            var num = suggestions.length/2;
            for (r in suggestions){
                var st1 = suggestions[r]["series_title"];
                var ct1 = suggestions[r]["core_title"];
                var crid1 = suggestions[r]["crid"];
                var desc = suggestions[r]["description"];
                var ppid = suggestions[r]["pid"];
                var img = suggestions[r]["image"];
                var pn1 = suggestions[r]["programme_number"];
                var ddtt = suggestions[r]["date_time"];
                var text_date = suggestions[r]["text_date"];
                var pid = suggestions[r]["pid"];
                var playlist = " <a href=\"#\" onclick=\"javascript:playlist_delete('"+crid1+"');return false;\">Delete from playlist</a> ";
                if(st1){
                  st1 = capitalise(st1);
                }
                if(ct1){
                  ct1 = capitalise(ct1);
                }
                s = s+"<div id=\""+crid1+"\">";

                if(img){
                   s = s+ "<div style=\"float:left;padding:10px\"><img src='"+img+"' width='200'/></div>";
                }
                if (st1 && st1!="" && st1!=" "){
                  s = s+"<div style=\"padding:10px\"><b><a href=\"#\" onclick=\"javascript:refresh_suggestions('"+crid1+"')\">"+st1+": "+ct1+"</a></b>"
                }else{
                  s = s+"<div style=\"padding:10px\"><b><a href=\"#\" onclick=\"javascript:refresh_suggestions('"+crid1+"')\">"+ct1+"</a></b>"
                }

                if(desc){
                   s = s+"<p>"+desc;
                   if(text_date){
                     s = s+" From "+text_date;
                   }
                   if(pid){
                     s = s+" <br /><a href='http://www.bbc.co.uk/programmes/"+pid+"' target='_blank'>BBC Website</a>";
                   }
                   s = s+"</p>\n"+playlist;
                }else{//horrible, sorry!
                  s = s+"<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>\n"+playlist;
                }
                s = s+ "</div></div>\n";

              }//end for
            }//end if
                 

  var a = document.getElementById("playlistget");
  a.innerHTML=s;
  //make show playlist button vsitble
  showPlaylistButton(user_id);

}

function show_playlist(user_id){
  if(playlist_changed){
    getPlaylist(user_id);
  }

  $("#playlistget").overlay({
        top: 100,
        mask: {
                color: '#111',
                loadSpeed: 100,
                opacity: 0.5
        },
        closeOnClick: true,
        load: false
  });
  $("#playlistget").data("overlay").load();

}

function show_cat_search(){

  $("#cat_search").overlay({
        top: 100,
        mask: {
                color: '#111',
                loadSpeed: 100,
                opacity: 0.5
        },
        closeOnClick: true,
        load: false
  });
  $("#cat_search").data("overlay").load();

}

/*
function addPlaylistUrl(user_id){

  var a = document.getElementById("playlist");
  var u ="http://dev.notu.be/2011/01/api/playlist?action=get&user_id="+user_id+"&fmt=html";

  var html="<a href='"+u+"' rel='#overlay' style='text-decoration:none' id='playlist_wrapper'><button type='button'>Show Playlist2</button></a>";

  a.innerHTML=html;
  foo();
}
*/

/*
function show_playlist(){

  var i = document.getElementById("playlist");
  i.innerHTML="<a href=\"#\" onclick=\"javascript:playlist_get('"+user_id+"');return false;\">Show Playlist</a>"
}
*/

function insert_with_src(sc) {
   var headID = document.getElementsByTagName("head")[0];
   var newScript = document.createElement('script');
   newScript.type = 'text/javascript';
   newScript.src = sc;
   headID.appendChild(newScript);
}


//1. just does the suggest thing
//2. that looks up the infax / crid on progs and finds the image
//3. finds descriptions for all of them

function refresh_suggestions(crid){
    //close the overlay if its open
    if($("#cat_search").data("overlay")){
      $("#cat_search").data("overlay").close();
    }
    //close the overlay if its open
    if($("#playlistget").data("overlay")){
      $("#playlistget").data("overlay").close();
    }
    var y =suggest_url+"?crid="+crid+"&fmt=json&user_id="+user_id;
    //alert(y);
    insert_with_src(y);
}

function out(msg) {
  var out = document.getElementById('out');
  out.innerHTML = msg;
}

function telly(msg) {
  var out = document.getElementById('telly');
  out.innerHTML = msg;
}
function title(msg) {
  var out = document.getElementById('title');
//  out.innerHTML = msg+" <small>("+user_id+")</small>";
  out.innerHTML = msg;
}
function image(msg) {
  var out = document.getElementById('image');
  out.innerHTML = msg;
}

function pidurl(pid) {
  var out = document.getElementById('pidurl');
  out.innerHTML =" (<a href=\"http://www.bbc.co.uk/programmes/"+pid+"\">/Programmes page</a>)<br />";
}
function playbuttonnear(text) {
  var out = document.getElementById('playbuttonnear');
  out.innerHTML = text;
}
function playbuttonfar(text) {
  var out = document.getElementById('playbuttonfar');
  out.innerHTML = text;
}

function suggest1(text) {
  var out = document.getElementById("suggestions1");
  out.innerHTML = text;
}
function print_cats(text) {
  var out = document.getElementById("cats");
  out.innerHTML = text;
}


//cookies stuff
//onload check for a specific cookie
//if not there. generate a random number, create a cookie; display T&Cs
//else use the one in the cookie

function checkCookies(){
  var cookie = readCookie('notube_eval1');
  if(cookie){
     checked = true;
     user_id=cookie;
  }else{
     checked = false;
     var r=Math.floor(Math.random()*10000000);
     user_id = 'nt_user_'+r
     createCookie('notube_eval1',user_id,7)
  }
}

function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}

//playlist stuff

function playlist_add(crid){
   playlist_changed=true;
   var u = "http://dev.notu.be/2011/01/api/playlist?action=add&user_id="+user_id+"&crid="+crid+"&fmt=json";

   var headID = document.getElementsByTagName("head")[0];
   var newScript = document.createElement('script');
   newScript.type = 'text/javascript';
   newScript.src = u;
   headID.appendChild(newScript);

}

function playlist_delete(crid){
   playlist_changed=true;
//alert("http://dev.notu.be/2011/01/api/playlist?action=delete&user_id="+user_id+"&crid="+crid+"&fmt=json");
   document.getElementById(crid).style.display = 'none';

   var u = "http://dev.notu.be/2011/01/api/playlist?action=delete&user_id="+user_id+"&crid="+crid+"&fmt=json";
   var headID = document.getElementsByTagName("head")[0];
   var newScript = document.createElement('script');
   newScript.type = 'text/javascript';
   newScript.src = u;
   headID.appendChild(newScript);

}


//playlist_get and playlist(results) is handled by html version using overlays


function send_email(){
 alert("email sent!");
 $("#TandCs").data("overlay").close();
}

</script>

  <div id="header">
    <span class="form" id="playlistButton"></span>
    <span class="playlistXML" id="playlistButtonXML"></span>
<!--<button type='button' onclick='javascript:show_playlist();return false;'>Show Playlist</button></span>-->
    <span class="random" id="random"><small><a href="#" onclick='javascript:do_random();return false;'>shuffle!</a></small></span>

  </div>
  <div id="wrapper">
	<div id="container">
		<div id="side-a">	
                  <h3 id="title">Browse Archive Video</h3>
                  <span id="image">
                  </span>


<p>
<div id="telly">
<p>
Thank you for participating in our research.
</p><p>

Please spend as much or as little time as you like over the next seven days to browse through this video 
collection and add programmes that you'd like to watch to your playlist using the <big>[+]</big> link beside 
each programme. If you get stuck, click on 'shuffle' to get a new random set of programmes.
</p><p>

You can use this application as many times as you want during the course of the week. You can 
access the playlist you make until the end of the NoTube project (March 2012). See the <a 
href="help.html">help</a> for more information about how you can use the playlist.
</p><p>
Please email us if you come across any bugs or would like to ask us any questions.
</p>
</div>
<span id="pidurl"></span>
<br />
<span id="cats"></span>
</p>
                </div>
                   
 
                      
                <span id="suggestions1"></span>



  </div>
</div>
<br />
<div id="footer">
<small><span id="out"></span></small>
</div>

<!-- overlays -->
<div class="simple_overlay" id="TandCs">
<h3>Hello!</h3>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra tempus augue, et condimentum sapien 
imperdiet vitae. Aliquam eget lobortis tellus. Cum sociis natoque penatibus et magnis dis parturient montes,
nascetur ridiculus mus. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;
Quisque non diam massa. Sed mollis interdum tempor. Cras ac nibh quis elit rhoncus viverra. Vivamus consectetur
ipsum vitae diam hendrerit eget tincidunt elit tincidunt. Donec in lorem fermentum tellus pulvinar pulvinar vel
vitae nulla. In vestibulum blandit lorem, eu lobortis sem vestibulum vitae. Curabitur varius turpis quis dui
varius hendrerit vitae eget massa. Phasellus euismod erat sed nibh elementum ac suscipit augue bibendum.
Phasellus sed quam sed orci feugiat sagittis. Sed velit dolor, scelerisque id interdum quis, tempus sed metus.
</p>
<form onsubmit="javascript:send_email();return false;">
Your email: <input type="text" name="email" value=""/><br />
I agree to the terms and conditions: <input type="checkbox" name="agree" value=""/><br />
<input type="submit" name="go" value="Send email and continue" />
</form>
        
</div>   

</body>

<script type="text/javascript">
//initial overlay stuff, occurs when no cookie
function popup_starter(){

  $("#TandCs").overlay({
        top: 100,
        mask: {
                color: '#111',
                loadSpeed: 200,
                opacity: 0.5
        },
        closeOnClick: true,
        load: true
  });
}


//add to playlist
function playlist_add_process(result){
          var suggestions = result["suggestions"];

          if (suggestions.length>0){
             var st1 = suggestions[0]["series_title"];
             var ct1 = suggestions[0]["core_title"];
             var ti = st1 +": "+ct1;
             var x = document.getElementById("playlistadded");
             x.innerHTML="Added "+ti+" to your playlist";
          }else{
             var x = document.getElementById("playlistadded");
             x.innerHTML="Sorry, someting went wrong.";            
          }


  setTimeout('$("#playlistadded").data("overlay").close();', 1500);

  $("#playlistadded").overlay({
        top: 100,
        mask: {
                color: '#111',
                loadSpeed: 100,
                opacity: 0.5
        },
        closeOnClick: true,
        load: false
  });
  $("#playlistadded").data("overlay").load();
}

//del from playlist
function playlist_del_process(result){
//alert("deleting");
}



</script>



<!-- overlayed element -->
<div class="simple_overlay" id="overlay">
        <!-- the external content is loaded inside this tag -->
        <div class="contentWrap"></div>
</div>

<!-- overlayed element -->
<div class="small_overlay" id="playlistadded">
        <!-- the external content is loaded inside this tag -->
        <div class="contentWrap"></div>
</div>

<!-- overlayed element -->
<div class="simple_overlay" id="playlistget">
        <!-- the external content is loaded inside this tag -->
        <div class="contentWrap"></div>
</div>

<div class="simple_overlay" id="cat_search">
        <!-- the external content is loaded inside this tag -->
        <div class="contentWrap"></div>
</div>


<script type="text/javascript">
//$(function() {
//                        alert("foo");


/*
function foo(){ 
        // if the function argument is given to overlay,
        // it is assumed to be the onBeforeLoad event listener
        $("a[rel]").overlay({
                mask: '#ddd',
                closeOnClick: true,
                onBeforeLoad: function() {
                        // grab wrapper element inside content
                        var wrap = this.getOverlay().find(".contentWrap");
                        // load the page specified in the trigger
                        wrap.load(this.getTrigger().attr("href"));
                }

        });
//});
}
*/
</script>

</html>

